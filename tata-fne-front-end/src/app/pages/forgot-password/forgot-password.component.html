<div class="login-page">
  <section class="form-panel">
    <div class="form-card">
   

      <div class="headline">
        <p class="eyebrow">Mot de passe oublié</p>
        <h1>Réinitialisation de mot de passe</h1>
        <p class="lede">Entrez votre adresse email pour recevoir un code de réinitialisation.</p>
      </div>

      @if (step() === 'email') {
        <form [formGroup]="forgotPasswordForm" (ngSubmit)="submitEmail()" novalidate>
          <label class="field-label" for="email">Adresse email *</label>
          <div class="field" [class.invalid]="forgotPasswordForm.get('email')?.invalid && forgotPasswordForm.get('email')?.touched">
            <input
              id="email"
              type="email"
              formControlName="email"
              placeholder="exemple@domaine.com"
              autocomplete="email"
            />
          </div>

          @if (errorMessage()) {
            <div class="error">
              {{ errorMessage() }}
            </div>
          }

          <button class="primary" type="submit" [disabled]="submitting()">
            {{ submitting() ? 'Envoi en cours...' : 'Envoyer le code' }}
          </button>

          <p class="hint">Un email contenant un code de sécurité vous sera envoyé.</p>
        </form>
      } @else if (step() === 'reset') {
        <form [formGroup]="resetPasswordForm" (ngSubmit)="submitReset()" novalidate>
          <label class="field-label" for="otp">Code de sécurité *</label>
          <div class="otp-container">
            @for (digit of otp; track $index) {
              <input
                id="otp-{{ $index }}"
                type="text"
                maxlength="1"
                inputmode="numeric"
                pattern="[0-9]"
                [value]="digit"
                (input)="onOtpChange($index, $event)"
                (paste)="onOtpPaste($event)"
                class="otp-input"
                autocomplete="one-time-code"
              />
            }
          </div>

          <label class="field-label" for="newPassword">Nouveau mot de passe *</label>
          <div class="field password-field" [class.invalid]="resetPasswordForm.get('newPassword')?.invalid && resetPasswordForm.get('newPassword')?.touched">
            <input
              id="newPassword"
              [type]="showPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="Nouveau mot de passe"
              autocomplete="new-password"
            />
            <button type="button" class="toggle" (click)="togglePassword()">
              {{ showPassword ? 'Masquer' : 'Afficher' }}
            </button>
          </div>

          <label class="field-label" for="confirmPassword">Confirmer le mot de passe *</label>
          <div class="field password-field" [class.invalid]="resetPasswordForm.get('confirmPassword')?.invalid && resetPasswordForm.get('confirmPassword')?.touched">
            <input
              id="confirmPassword"
              [type]="showPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Confirmez le mot de passe"
              autocomplete="new-password"
            />
            <button type="button" class="toggle" (click)="togglePassword()">
              {{ showPassword ? 'Masquer' : 'Afficher' }}
            </button>
          </div>

          @if (resetPasswordForm.get('confirmPassword')?.invalid && resetPasswordForm.get('confirmPassword')?.touched && resetPasswordForm.get('confirmPassword')?.errors?.['mismatch']) {
            <div class="error">
              Les mots de passe ne correspondent pas
            </div>
          }

          @if (errorMessage()) {
            <div class="error">
              {{ errorMessage() }}
            </div>
          }

          <button class="primary" type="submit" [disabled]="submitting()">
            {{ submitting() ? 'Réinitialisation en cours...' : 'Réinitialiser le mot de passe' }}
          </button>

          <p class="hint">Le code est valable 15 minutes.</p>
        </form>
      } @else if (step() === 'success') {
        <div class="success-message">
          <div class="success-icon">✓</div>
          <h2>Mot de passe réinitialisé avec succès</h2>
          <p>Votre mot de passe a été mis à jour. Vous pouvez maintenant vous connecter avec votre nouveau mot de passe.</p>
          <button class="primary" (click)="goToLogin()">Se connecter</button>
        </div>
      }

      <div class="actions">
        <a routerLink="/login" class="link" (click)="goToLogin()">Retour à la connexion</a>
      </div>
    </div>
  </section>
</div>