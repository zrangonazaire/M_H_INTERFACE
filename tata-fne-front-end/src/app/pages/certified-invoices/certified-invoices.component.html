<div class="layout">
<app-menu-gauche></app-menu-gauche>

  <div class="content">
    <header class="topbar">
      <div class="breadcrumbs">Pages / Factures certifiées</div>
      <div class="top-actions">
        <a class="link">{{ userFullName() }}</a>
      </div>
    </header>

    <section class="page-heading">
      <p class="eyebrow">Factures certifiées</p>
    </section>

    <section class="company-card">
      <div class="company-header">
        <div class="company-name">MODERNE HYGIENE</div>
        <div class="company-subtitle">Factures certifiées - Gestion complète</div>
      </div>
      <div class="company-grid">
        <div class="company-info">
          <span class="label">Régime d'imposition :</span>
          <span class="value">RNI</span>
        </div>
        <div class="company-info">
          <span class="label">Secteur d'activité :</span>
          <span class="value">Commerce de véhicules automobiles neufs</span>
        </div>
        <div class="company-info">
          <span class="label">IDU :</span>
          <span class="value">CI20120000178D</span>
        </div>
        <div class="company-info">
          <span class="label">NCC :</span>
          <span class="value">1218049R</span>
        </div>
        <div class="company-info">
          <span class="label">Direction de rattachement :</span>
          <span class="value">DRAS II</span>
        </div>
        <div class="company-info">
          <span class="label">Centre d'impôts / Poste comptable :</span>
          <span class="value">809 Impôts de Marcory I</span>
        </div>
      </div>
    </section>

    <!-- <section class="filters">
      <div class="pill pill-certified">Factures certifiées</div>
      <div class="pill pill-sales">Ventes & Avoirs</div>
      <div class="pill pill-management">Gestion complète</div>
    </section> -->

    <section class="tabs-section">
      <div class="tabs">
        <button 
          class="tab-btn" 
          [class.active]="currentTab() === 'sales'"
          (click)="currentTab.set('sales')"
        >
          Ventes
        </button>
        <button 
          class="tab-btn" 
          [class.active]="currentTab() === 'refunds'"
          (click)="currentTab.set('refunds')"
        >
          Avoirs
        </button>
      </div>
      <div class="heading-actions">
        <input
          type="search"
          placeholder="Rechercher par numéro, référence ou token"
          [ngModel]="search()"
          (ngModelChange)="search.set($event)"
        />
        <select [ngModel]="creatorFilter()" (ngModelChange)="creatorFilter.set($event)">
          <option [ngValue]="'all'">Tous les utilisateurs</option>
          @for (creator of creators(); track $index) {
            @if (creator !== 'all') {
              <option [ngValue]="creator">{{ creator }}</option>
            }
          }
        </select>
        <button class="refresh" type="button" (click)="load()">Rafraîchir</button>
      </div>
    </section>

    @if (error()) {
      <div class="alert error">
        {{ error() }}
        <button type="button" (click)="load()">Réessayer</button>
      </div>
    }

    @if (loading()) {
      <div class="loading">Chargement des factures certifiées...</div>
    } @else {
      <section class="summary">
        <div class="summary-card">
          <p>Total factures</p>
          <h2>{{ totals().count }}</h2>
        </div>
        <div class="summary-card">
          <p>Total TTC</p>
          <h2>{{ formatMoney(totals().ttc) }}</h2>
        </div>
        <div class="summary-card">
          <p>Total HT</p>
          <h2>{{ formatMoney(totals().ht) }}</h2>
        </div>
        <div class="summary-card">
          <p>Total Taxes</p>
          <h2>{{ formatMoney(totals().taxes) }}</h2>
        </div>
      </section>

      <section class="card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type de facture</th>
                <th>Numéro interne</th>
                <th>Référence</th>
                <th>Utilisateur</th>
                <th>Date</th>
                <th>Total HT</th>
                <th>Total Taxes</th>
                <th>Total TTC</th>
                <th>Token</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of filtered(); track trackById($index, invoice)) {
                <tr>
                  <td>
                    <span [class]="(invoice.invoiceType || '').toLowerCase() === 'sale' ? 'badge badge-success' : 'badge badge-warning'">
                      {{ (invoice.invoiceType || '').toLowerCase() === 'sale' ? 'Vente' : 'Avoir' }}
                    </span>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ invoice.numeroFactureInterne || '-' }}</div>
                    <small class="muted">ID: {{ invoice.id }}</small>
                  </td>
                  <td>{{ invoice.reference || '-' }}</td>
                  <td>{{ invoice.utilisateurCreateur || '-' }}</td>
                  <td>{{ formatDate(invoice.date) }}</td>
                  <td>{{ formatMoney(invoice.totalHorsTaxes) }}</td>
                  <td>{{ formatMoney(invoice.totalTaxes) }}</td>
                  <td>{{ formatMoney(invoice.totalTTC) }}</td>
                  <td class="token">
                    @if (invoice.token) {
                      <a class="token-link" [href]="invoice.token" target="_blank" rel="noreferrer noopener">{{ invoice.token }}</a>
                    } @else {
                      -
                    }
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="10" class="empty">Aucune facture certifiée trouvée.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    }
  </div>
</div>
