<div class="layout">
<app-menu-gauche></app-menu-gauche>

  <div class="content">
    <header class="topbar">
      <div class="breadcrumbs">Pages / Factures certifiées</div>
      <div class="top-actions">
        <a class="link">{{ userFullName() }} - {{ userPdv() }} - {{ userEtab() }}</a>
      </div>
    </header>

    <section class="page-heading">
      <p class="eyebrow">Factures certifiées</p>
    </section>

    <section class="company-card">
      <div class="company-header">
        <div class="company-name">MODERNE HYGIENE</div>
        <div class="company-subtitle">Factures certifiées - Gestion complète</div>
      </div>
      <div class="company-grid">
        <div class="company-info">
          <span class="label">Régime d'imposition :</span>
          <span class="value">RNI</span>
        </div>
        <div class="company-info">
          <span class="label">Secteur d'activité :</span>
          <span class="value">Commerce de véhicules automobiles neufs</span>
        </div>
        <div class="company-info">
          <span class="label">IDU :</span>
          <span class="value">CI20120000178D</span>
        </div>
        <div class="company-info">
          <span class="label">NCC :</span>
          <span class="value">1218049R</span>
        </div>
        <div class="company-info">
          <span class="label">Direction de rattachement :</span>
          <span class="value">DRAS II</span>
        </div>
        <div class="company-info">
          <span class="label">Centre d'impôts / Poste comptable :</span>
          <span class="value">809 Impôts de Marcory I</span>
        </div>
      </div>
    </section>

    <!-- <section class="filters">
      <div class="pill pill-certified">Factures certifiées</div>
      <div class="pill pill-sales">Ventes & Avoirs</div>
      <div class="pill pill-management">Gestion complète</div>
    </section> -->

    <section class="tabs-section">
      <div class="tabs">
        <button 
          class="tab-btn" 
          [class.active]="currentTab() === 'sales'"
          (click)="setCurrentTab('sales')"
        >
          Ventes
        </button>
        <button 
          class="tab-btn" 
          [class.active]="currentTab() === 'refunds'"
          (click)="setCurrentTab('refunds')"
        >
          Avoirs
        </button>
      </div>
      <div class="heading-actions">
        <input
          type="search"
          placeholder="Rechercher par numéro, référence ou token"
          [ngModel]="search()"
          (ngModelChange)="search.set($event); currentPage.set(0)"
        />
        <select [ngModel]="creatorFilter()" (ngModelChange)="creatorFilter.set($event); currentPage.set(0)">
          <option [ngValue]="'all'">Tous les utilisateurs</option>
          @for (creator of creators(); track $index) {
            @if (creator !== 'all') {
              <option [ngValue]="creator">{{ creator }}</option>
            }
          }
        </select>
        <button class="refresh secondary" type="button" (click)="resetFilters()">Réinitialiser les filtres</button>
        <button class="refresh" type="button" (click)="load()">Rafraîchir</button>
      </div>

      <div class="advanced-filters">
        <div class="filter-field">
          <label>Période (date d'enregistrement)</label>
          <select [ngModel]="periodFilter()" (ngModelChange)="onPeriodChange($event)">
            <option [ngValue]="'all'">Toutes</option>
            <option [ngValue]="'today'">Aujourd'hui</option>
            <option [ngValue]="'last7'">7 derniers jours</option>
            <option [ngValue]="'last30'">30 derniers jours</option>
            <option [ngValue]="'thisMonth'">Ce mois</option>
            <option [ngValue]="'lastMonth'">Mois précédent</option>
            <option [ngValue]="'thisYear'">Cette année</option>
            <option [ngValue]="'custom'">Personnalisée</option>
          </select>
        </div>

        <div class="filter-field">
          <label>Date du</label>
          <input type="date" [ngModel]="dateFrom()" (ngModelChange)="dateFrom.set($event); onDateRangeChange()" />
        </div>

        <div class="filter-field">
          <label>Date au</label>
          <input type="date" [ngModel]="dateTo()" (ngModelChange)="dateTo.set($event); onDateRangeChange()" />
        </div>

        <div class="filter-field">
          <label>Type de montant</label>
          <select [ngModel]="amountTypeFilter()" (ngModelChange)="amountTypeFilter.set($event); currentPage.set(0)">
            <option [ngValue]="'ttc'">Total TTC</option>
            <option [ngValue]="'ht'">Total HT</option>
          </select>
        </div>

        <div class="filter-field">
          <label>Montant minimum</label>
          <input
            type="text"
            placeholder="Ex: 100000"
            [ngModel]="amountMinFilter()"
            (ngModelChange)="amountMinFilter.set($event); currentPage.set(0)"
          />
        </div>

        <div class="filter-field">
          <label>Montant maximum</label>
          <input
            type="text"
            placeholder="Ex: 500000"
            [ngModel]="amountMaxFilter()"
            (ngModelChange)="amountMaxFilter.set($event); currentPage.set(0)"
          />
        </div>

        <!-- <div class="filter-field">
          <label>Token</label>
          <select [ngModel]="tokenFilter()" (ngModelChange)="tokenFilter.set($event); currentPage.set(0)">
            <option [ngValue]="'all'">Tous</option>
            <option [ngValue]="'with'">Avec token</option>
            <option [ngValue]="'without'">Sans token</option>
          </select>
        </div> -->

        @if (currentTab() === 'sales') {
          <div class="filter-field">
            <label>Etat Facture vente / avoir</label>
            <select [ngModel]="salesRefundFilter()" (ngModelChange)="salesRefundFilter.set($event); currentPage.set(0)">
              <option [ngValue]="'all'">Toutes</option>
              <option [ngValue]="'withoutRefund'">Sans avoir</option>
              <option [ngValue]="'withRefund'">Avec avoir</option>
            </select>
          </div>
        }
      </div>
    </section>

    @if (error()) {
      <div class="alert error">
        {{ error() }}
        <button type="button" (click)="load()">Réessayer</button>
      </div>
    }

    @if (loading()) {
      <div class="loading">Chargement des factures certifiées...</div>
    } @else {
      <section class="summary">
        <div class="summary-card">
          <p>Total resultats</p>
          <h2>{{ totals().count }}</h2>
        </div>
        <div class="summary-card">
          <p>Total TTC</p>
          <h2>{{ formatMoney(totals().ttc) }}</h2>
        </div>
        <div class="summary-card">
          <p>Total HT</p>
          <h2>{{ formatMoney(totals().ht) }}</h2>
        </div>
        <div class="summary-card">
          <p>Total Taxes</p>
          <h2>{{ formatMoney(totals().taxes) }}</h2>
        </div>
      </section>

      <section class="card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Type de facture</th>
                <th>Numéro interne</th>
                <th>Référence</th>
                <th>Utilisateur</th>
                <th>Date enregistrement</th>
                <th>Total HT</th>
                <th>Total Taxes</th>
                <th>Total TTC</th>
                <th>Token</th>
                <th class="actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of paginatedItems(); track trackById($index, invoice)) {
                <tr>
                  <td>
                    <span [class]="(invoice.invoiceType || '').toLowerCase() === 'sale' ? 'badge badge-success' : 'badge badge-warning'">
                      {{ (invoice.invoiceType || '').toLowerCase() === 'sale' ? 'Vente' : 'Avoir' }}
                    </span>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ getInternalNumber(invoice) }}</div>
                    <small class="muted">ID: {{ invoice.id }}</small>
                  </td>
                  <td>{{ invoice.reference || '-' }}</td>
                  <td>{{ getCreator(invoice) || '-' }}</td>
                  <td>{{ formatDate(getRegistrationDate(invoice)) }}</td>
                  <td>{{ formatMoney(getAmountValue(invoice, 'ht')) }}</td>
                  <td>{{ formatMoney(getAmountValue(invoice, 'taxes')) }}</td>
                  <td>{{ formatMoney(getAmountValue(invoice, 'ttc')) }}</td>
                  <td class="token">
                    @if (invoice.token) {
                      <a class="token-link" [href]="invoice.token" target="_blank" rel="noreferrer noopener">{{ invoice.token }}</a>
                    } @else {
                      -
                    }
                  </td>
                  <td>
                    @if ((invoice.invoiceType || '').toLowerCase() === 'sale') {
                      @if (shouldShowCreateCreditNoteButton(invoice)) {
                        <button 
                          class="btn btn-primary" 
                          [disabled]="!hasFacturierRole()"
                          (click)="createCreditNote(invoice)">
                          Faire un avoir
                        </button>
                      } @else {
                        <span class="muted">Avoir existant</span>
                      }
                    }
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="10" class="empty">Aucun résultat pour ces filtres.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (filtered().length > 0) {
          <div class="pagination-wrapper">
            <div class="pagination-info">{{ getPaginationInfo() }}</div>
            <div class="pagination-controls">
              <div class="page-size">
                <label>Par page:</label>
                <select [ngModel]="pageSize()" (ngModelChange)="setPageSize($event)">
                  <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
                </select>
              </div>
              <div class="page-nav">
                <button (click)="firstPage()" [disabled]="currentPage() === 0" title="Première page">&laquo;</button>
                <button (click)="previousPage()" [disabled]="currentPage() === 0" title="Page précédente">&lsaquo;</button>
                <ng-container *ngFor="let page of getVisiblePages()">
                  <button *ngIf="page !== -1" [class.active]="currentPage() === page" (click)="setPage(page)">{{ page + 1 }}</button>
                  <span *ngIf="page === -1" class="ellipsis">...</span>
                </ng-container>
                <button (click)="nextPage()" [disabled]="currentPage() >= totalPages() - 1" title="Page suivante">&rsaquo;</button>
                <button (click)="lastPage()" [disabled]="currentPage() >= totalPages() - 1" title="Dernière page">&raquo;</button>
              </div>
            </div>
          </div>
        }
      </section>
    }
  </div>
</div>




