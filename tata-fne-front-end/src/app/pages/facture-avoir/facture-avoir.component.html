<div class="layout">
<app-menu-gauche></app-menu-gauche>

  <div class="content">
    <header class="topbar">
      <div class="breadcrumbs">Pages / Avoir</div>
      <div class="top-actions">
        <a class="link">{{ userFullName() }} - {{ userPdv() }} - {{ userEtab() }}</a>
      </div>
    </header>

    <section class="page-heading">
      <p class="eyebrow">Création d'un avoir</p>
      <div class="heading-actions">
        <button class="btn btn-secondary" (click)="backToInvoices()">Retour aux factures</button>
      </div>
    </section>

    @if (loading()) {
      <div class="loading">Chargement de la facture...</div>
    } @else if (error()) {
        <div class="alert error">
          {{ error() }}
          <button type="button" (click)="loadInvoice()">Réessayer</button>
        </div>
    } @else if (invoice()) {
      <section class="card">
        <div class="invoice-header">
          <div class="invoice-info">
            <div class="invoice-main-info">
              <div class="invoice-title-section">
                <h1 class="invoice-title">Facture {{ invoice()!.reference }}</h1>
                <div class="invoice-meta">
                  <span class="invoice-id">ID: {{ invoice()!.id }}</span>
                  <span [class]="invoice()!.invoiceType === 'sale' ? 'badge badge-success' : 'badge badge-warning'">
                    {{ invoice()!.invoiceType === 'sale' ? 'Vente' : 'Avoir' }}
                  </span>
                </div>
              </div>
              <div class="invoice-details">
                <div class="detail-row">
                  <span class="detail-label">Date:</span>
                  <span class="detail-value">{{ formatDate(invoice()!.date) }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Utilisateur:</span>
                  <span class="detail-value">{{ invoice()!.utilisateurCreateur }}</span>
                </div>
              </div>
            </div>
            
            <div class="invoice-total-section">
              <div class="total-label">Total TTC</div>
              <div class="total-amount">{{ formatMoney(invoice()!.totalTTC) }}</div>
              <div class="download-section">
                @if (invoice()!.token) {
                  <a [href]="invoice()!.token" 
                     target="_blank" 
                     rel="noopener noreferrer" 
                     class="download-link">
                    Télécharger la facture Vente
                  </a>
                } @else {
                  <span class="muted">Token non disponible</span>
                }
              </div>
            </div>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ID Produit</th>
                 <th>Référence</th>
                <th>Produit</th>
               
                <!-- <th>Quantité</th>
                <th>Prix unitaire</th>
                <th>Montant HT</th>
                <th>Montant TTC</th> -->
              </tr>
            </thead>
            <tbody>
              @for (item of invoice()!.items || []; track $index) {
                <tr>
                  <td>{{ item.id }}</td>
                    <td>{{ item.reference || '-' }}</td>
                  <td>{{ item.description || 'Produit sans description' }}</td>
                
                  <!-- <td>{{ item.quantity || 0 }}</td> -->
                  <!-- <td>{{ formatMoney(item.amount ) }}</td>
                  <td>{{ formatMoney((item.amount ) * (item.creditQuantity || 0)) }}</td>
                  <td>{{ formatMoney(item.amount ) }}</td> -->
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- <div class="credit-summary">
          <div class="summary-row">
            <span>Total à avoir:</span>
            <span class="total-amount">{{ formatMoney(creditTotal()) }}</span>
          </div>
        </div> -->

        <div class="actions">
          <button class="btn btn-primary" (click)="createCreditNote()">Créer la facture Avoir</button>
        </div>
      </section>
    } @else {
      <div class="alert error">
        Aucune facture sélectionnée.
        <button type="button" (click)="backToInvoices()">Retour aux factures</button>
      </div>
    }
  </div>
</div>
