<div class="layout">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="/logo.png" alt="Logo" />
      </div>
      <div class="brand-caption">Facture Normalisée Électronique</div>
    </div>

    <nav class="menu">
      <a class="menu-item" routerLink="/dashboard" routerLinkActive="active">
        <span class="icon">D</span>
        Tableau de bord
      </a>
      <a class="menu-item" routerLink="/factures-non-certifiees" routerLinkActive="active">
        <span class="icon">X</span>
        Certification par fichier Excel
      </a>
      <a class="menu-item">
        <span class="icon">A</span>
        Certification par API SAP
      </a>
      <a class="menu-item" routerLink="/factures-certifiees" routerLinkActive="active">
        <span class="icon">F</span>
        Factures Certifiées
      </a>
      <a class="menu-item" routerLink="/parametres" routerLinkActive="active">
        <span class="icon">P</span>
        Paramètres
      </a>
    </nav>

    <div class="logout">
      <button type="button" (click)="logout()">Se déconnecter</button>
      <small>v1.0.2 (04/11/2025)</small>
    </div>
  </aside>

  <div class="content">
    <header class="topbar">
      <div class="breadcrumbs">Pages / Avoir</div>
      <div class="top-actions">
        <a class="link">{{ userFullName() }}</a>
        <a class="link">Notifications</a>
      </div>
    </header>

    <section class="page-heading">
      <p class="eyebrow">Création d'un avoir</p>
      <div class="heading-actions">
        <button class="btn btn-secondary" (click)="backToInvoices()">Retour aux factures</button>
      </div>
    </section>

    @if (loading()) {
      <div class="loading">Chargement de la facture...</div>
    } @else if (error()) {
        <div class="alert error">
          {{ error() }}
          <button type="button" (click)="loadInvoice()">Réessayer</button>
        </div>
    } @else if (invoice()) {
      <section class="card">
        <div class="invoice-header">
          <div class="invoice-info">
            <h2>Facture {{ invoice()!.reference }}</h2>
            <p><strong>ID Facture:</strong> {{ invoice()!.id }}</p>
            <p><strong>Type:</strong> <span [class]="invoice()!.invoiceType === 'sale' ? 'badge badge-success' : 'badge badge-warning'">{{ invoice()!.invoiceType === 'sale' ? 'Vente' : 'Avoir' }}</span></p>
            <p><strong>Date:</strong> {{ formatDate(invoice()!.date) }}</p>
            <p><strong>Utilisateur:</strong> {{ invoice()!.utilisateurCreateur }}</p>
            <p><strong>Total TTC:</strong> {{ formatMoney(invoice()!.totalTTC) }}</p>
          </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ID Produit</th>
                <th>Produit</th>
                <th>Référence</th>
                <th>Quantité initiale</th>
                <th>Quantité à avoir</th>
                <th>Prix unitaire</th>
                <th>Montant</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              @for (item of invoice()!.items || []; track $index) {
                <tr>
                  <td>{{ item.id }}</td>
                  <td>{{ item.description || 'Produit sans description' }}</td>
                  <td>{{ item.reference || '-' }}</td>
                  <td>{{ item.quantity || 0 }}</td>
                  <td>
                    <input 
                      type="number" 
                      [value]="item.quantity || 0"
                      (input)="updateCreditQuantity(item, $any($event.target).value)"
                      min="0"
                      [max]="item.quantity || 0"
                      class="quantity-input"
                    />
                  </td>
                  <td>{{ formatMoney(item.amount / (item.quantity || 1)) }}</td>
                  <td>{{ formatMoney((item.amount / (item.quantity || 1)) * (item.creditQuantity || 0)) }}</td>
                  <td>
                    <button class="btn btn-primary" (click)="createCreditNoteForItem(item)">Valider l'avoir</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="credit-summary">
          <div class="summary-row">
            <span>Total à avoir:</span>
            <span class="total-amount">{{ formatMoney(creditTotal()) }}</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" (click)="createCreditNote()">Créer l'avoir</button>
          <button class="btn btn-secondary" (click)="resetQuantities()">Réinitialiser</button>
        </div>
      </section>
    } @else {
      <div class="alert error">
        Aucune facture sélectionnée.
        <button type="button" (click)="backToInvoices()">Retour aux factures</button>
      </div>
    }
  </div>
</div>